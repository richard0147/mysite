{% load staticfiles %}
<!DOCTYPE html>
<html>
   <head>
      <title>报告预览</title>
      <!-- 引入 Bootstrap -->
      <link href="{% static 'reports/css/bootstrap.min.css' %}" rel="stylesheet">
      <!--script type="text/javascript" src="{% static 'reports/js/jquery.js' %}"></script-->
      <script type="text/javascript" src="{% static 'reports/js/jquery-1.7.1.min.js' %}"></script>
      <!-- 包括所有已编译的插件 -->
      <script type="text/javascript" src="{% static 'reports/js/bootstrap.min.js' %}"></script>
      
      <!-- 时间选择插件 -->
      <link type="text/css" href="{% static 'reports/css/jquery-ui-1.8.17.custom.css' %}" rel="stylesheet" />
      <link type="text/css" href="{% static 'reports/css/jquery-ui-timepicker-addon.css' %}" rel="stylesheet" />
      <!--script type="text/javascript" src="js/jquery-1.7.1.min.js"></script-->
	  <script type="text/javascript" src="{% static 'reports/js/jquery-ui-1.8.17.custom.min.js' %}"></script>
	  <script type="text/javascript" src="{% static 'reports/js/jquery-ui-timepicker-addon.js' %}"></script>
      <script type="text/javascript" src="{% static 'reports/js/jquery-ui-timepicker-zh-CN.js' %}"></script>
      <script type="text/javascript" src="{% static 'reports/dist/echarts.js' %}"></script>
    
    <script type="text/javascript">
    $(function () {
        $(".ui_timepicker").datetimepicker({
            //showOn: "button",
            //buttonImage: "./css/images/icon_calendar.gif",
            //buttonImageOnly: true,
            showSecond: false,
            timeFormat: 'hh:mm',
            stepHour: 1,
            stepMinute: 1,
            stepSecond: 1
        })
        
        //var mrtg_labels=$("#mrtg_select_image").children('label');
        var mrtg_labels=$("input.mrtg-format").parent('label');
        //var mrtg_images=$("#mrtg_select_image").children('img');
        var mrtg_images=$("img.mrtg-format");
        //将图片放置到制定的元素位置
        for(var i=0;i<mrtg_labels.length;i++){
            var mrtg_label=mrtg_labels[i];
            //alert(mrtg_label);
            var value=$($(mrtg_label).children()[0]).attr('value');
            for(var j=0;j<mrtg_images.length;j++){
                var mrtg_image=mrtg_images[j];
                var index=$(mrtg_image).attr('index');
                if( value===index){
                    $(mrtg_label).append(mrtg_image)
                    //mrtg_image.remove()
                }
            }
        }
        
        
        //元素包裹-分行
        //row,col,offset
        row_add($(".persion-format"),3,'2','2');
        row_add($(".domain-format"),2,'3','2');
        row_add($(".ip-format"),2,'3','2');
        row_add($(".process-format"),1,'8','2');
        
        //wrap在每个被选元素的周围用 HTML 元素包裹起来
        $(".mrtg-format").parent('label').wrap('<div class="col-lg-3"></div>');
        var show_persion_nb="{{show_persion_nb}}";
        var show_domain_nb="{{show_domain_nb}}";
        var show_ip_nb="{{show_ip_nb}}";
        var show_process_nb="{{show_process_nb}}";
        
        if(typeof(show_persion_nb) == "undefined" || typeof(show_persion_nb) == "null" || show_persion_nb == null || show_persion_nb == ""||show_persion_nb==="0"){
            show_persion_nb=2
        }
        if(typeof(show_domain_nb) == "undefined" || typeof(show_domain_nb) == "null" || show_domain_nb == null || show_domain_nb == ""||show_domain_nb==="0"){
            show_domain_nb=2
        }
        if(typeof(show_ip_nb) == "undefined" || typeof(show_ip_nb) == "null" || show_ip_nb == null || show_ip_nb == ""||show_ip_nb==="0"){
            show_ip_nb=2
        }
        if(typeof(show_process_nb) == "undefined" || typeof(show_process_nb) == "null" || show_process_nb == null || show_process_nb == ""||show_process_nb==="0"){
            show_process_nb=2
        }
        //元素隐藏
        hide_ele($(".persion-format"),Number(show_persion_nb)+1);
        hide_ele($(".domain-format"),Number(show_domain_nb)+1);
        hide_ele($(".ip-format"),Number(show_ip_nb)+1);
        hide_ele($(".process-format"),Number(show_process_nb)+1);
        $(".dnsla-img").hide();
        
        
        //将添加按钮放置在最后一个显示元素的后面
        put_btn_after_show_ele($(".persion-format"),"btn-persion");
        put_btn_after_show_ele($(".domain-format"),"btn-domain");
        put_btn_after_show_ele($(".ip-format"),"btn-ip");
        put_btn_after_show_ele($(".process-format"),"btn-process");
        
        $(".mrtg-format").click(click_mrtg_image);
        
        {% if is_create %}
        {% else %}
          {% if is_change_valid %}
            get_dnsla_data_by_reportid("{{report_id}}")
          {% else %}
            {% for nodeid in nodeidlist %}
            get_dnsla_data_by_nodeid("{{nodeid}}");
            $("#dnsla-img{{nodeid}}").show();
            $("#dnsla-img-head{{nodeid}}").show();
            {% endfor %}
          {% endif %}
        {% endif %}
        
        {% if is_valid %}
        {% else %}
          {% for nodeid in nodeidlist %}
            get_dnsla_data_by_nodeid("{{nodeid}}");
            $("#dnsla-img{{nodeid}}").show();
            $("#dnsla-img-head{{nodeid}}").show();
          {% endfor %}
        {% endif %}
    })
    function get_dnsla_data_by_reportid(value){
        if(value!=""){
            $.ajax({
                type: 'get',
                url: '/reports/getDnslaOldData/'+value+'/' ,
                success: function(data){
                    // ECharts路径配置
                    
                    require.config({
                        paths: {
                            echarts: "{% static 'reports/dist' %}"
                        }
                    });
                    // 使用
                    require(['echarts','echarts/chart/bar' // 使用柱状图就加载bar模块，按需加载
                    ],
                        function (ec) {
                            for( key in data){
                                if(key==='0'){
                                  continue;
                                }
                                //显示画布
                                $("#dnsla-img"+key).show();
                                $("#dnsla-img-head"+key).show();
                                // 基于准备好的dom，初始化echarts图表
                                var myChart_dname = ec.init(document.getElementById('dnsla-dname-img'+key));
                                var myChart_addr = ec.init(document.getElementById('dnsla-addr-img'+key));
                                //var myChart = ec.init(document.getElementById('dnsla-dname-img1'));                      
                                 var option_dname = {
                                    title:{text:'域名',x:'center'},
                                    tooltip: {trigger:'axis'},
                                    xAxis : [{type : 'value'}],
                                    yAxis : [{"type" : 'category',"data" : data[key].dname.y}],
                                    series : [{"name":"","type":"bar","data":data[key].dname.x}]
                                };
                                var option_addr = {
                                    title:{text:'ip',x:'center'},
                                    tooltip: {trigger:'axis'},
                                    xAxis : [{type : 'value'}],
                                    yAxis : [{"type" : 'category',"data" : data[key].addr.y}],
                                    series : [{"name":"","type":"bar","data":data[key].addr.x}]
                                };
                                
                                // 为echarts对象加载数据  渲染dnsla数据
                                myChart_dname.setOption(option_dname); 
                                myChart_addr.setOption(option_addr); 
                                }
                        }
                    );
                } ,
                dataType: 'json'
            });//ajax
        }//if
      }
      
    function get_dnsla_data_by_nodeid(value){
      if(value!=""&& value!="0"){
          $.ajax({
                type: 'get',
                url: '/reports/getDnslaCurrentData/'+value+'/' ,
                success: function(data){
                  if (data!=""){
                    data.name
                    // ECharts路径配置
                    require.config({
                        paths: {
                            echarts: "{% static 'reports/dist' %}"
                            
                        }
                    });
                    // 使用
                    require(
                        [
                            'echarts',
                            'echarts/chart/bar' // 使用柱状图就加载bar模块，按需加载
                        ],
                        function (ec) {
                            // 基于准备好的dom，初始化echarts图表
                            var myChart_dname = ec.init(document.getElementById('dnsla-dname-img'+value));
                            var myChart_addr = ec.init(document.getElementById('dnsla-addr-img'+value));
                            //var myChart = ec.init(document.getElementById('dnsla-dname-img1'));                      
                             var option_dname = {
                                title:{text:'域名',x:'center'},
                                tooltip: {trigger:'axis'},
                                xAxis : [{type : 'value'}],
                                yAxis : [{"type" : 'category',"data" : data.dname.y}],
                                series : [{"name":"","type":"bar","data":data.dname.x}]
                            };
                            var option_addr = {
                                title:{text:'ip',x:'center'},
                                tooltip: {trigger:'axis'},
                                xAxis : [{type : 'value'}],
                                yAxis : [{"type" : 'category',"data" : data.addr.y}],
                                series : [{"name":"","type":"bar","data":data.addr.x}]
                            };
                            
                            // 为echarts对象加载数据  渲染dnsla数据
                            myChart_dname.setOption(option_dname); 
                            myChart_addr.setOption(option_addr); 
                            
                        }
                    );
                  }
                } ,
                dataType: 'json'
            });//ajax
        }//if
    }//fucntion
    
    //点击mrtg请求触发的函数
    function click_mrtg_image(){
        var value=$(this).attr('value');
        //判断
        if (value==="0"){
            return;
        }
        if($("#dnsla-img"+value).is(":hidden")){
            $("#dnsla-img"+value).show();
            $("#dnsla-img-head"+value).show();
            //发送ajax请求 获取dnsla图片数据
            get_dnsla_data_by_nodeid(value);
        }else{
            $("#dnsla-img"+value).hide();
            $("#dnsla-img-head"+value).hide();
            $("#dnsla-dname-img"+value).empty();
            $("#dnsla-addr-img"+value).empty();
        }
        return;
        
        
    }
    function put_btn_after_show_ele(eles,btn_id){
        var divs=$(eles).parent('div');
        var set_btn=false;
        for (i=0;i<eles.length;i++){
            if ($(eles[i]).is(":hidden")){
                $(divs[i-1]).after($("#"+btn_id))
                set_btn=true;
                break;
            }
        }
        
        if (set_btn===false){
            $(divs[divs.length-1]).after($("#"+btn_id));
        }
        return;
        
    }
    
    //row_num:每行元素的个数
    function row_add(eles,row_num,col_num,offset){
        //先添加列包裹
        $(eles).wrap('<div class="col-lg-'+col_num+'"></div>');
        
        //找到父div标签
        var divs=$(eles).parent('div');
        
        $(divs[0]).attr('class','col-lg-'+offset);
        var i=0;
        //第一行不偏移!
        var first_line=true;
        
        for (i=0;i+row_num<divs.length;){
            if (first_line===false){
                var rnb=row_num;
            }else{
                var rnb=row_num+1;
            }
            
            var row=new Array();
            for(var j=0;j<rnb;j++){
                row[j]=divs[i+j];
            }
            i+=rnb;
            
            //添加行包裹
            //wrapAll在所有被选元素的周围用 HTML 元素包裹起来
            $(row).wrapAll('<div class="row"></div>');
            if (first_line===false){
                $(row[0]).addClass('col-lg-offset-'+offset);
            }else{
                first_line=false;
            }
        }
        
        //收尾处理
        var row=new Array();
        for (var j=0;i+j<divs.length;j++){
            row[j]=divs[i+j];
        }
        $(row).wrapAll('<div class="row"></div>');
        if (first_line===false){
            $(row[0]).addClass('col-lg-offset-'+offset);
        }
        return
    }
    
    function hide_ele(eles,num){
        for (var i=0;i<eles.length;i++){
            if (i>=num){
                $(eles[i]).hide()
            }
        }
        return;
    }
    

    function show_one_class_ele(class_name,btn_id){
        var eles=$("."+class_name);
        for (var i=0;i<eles.length;i++){
            if ($(eles[i]).is(":hidden")){
                $(eles[i]).show();
                break;
            }
        }
        put_btn_after_show_ele(eles,btn_id);
        return;
    }
    
    </script>
  </head>
  <body>
    <div class="row" >
    <div class="col-lg-12">
      <h1 align="center">故障报告生成系统</h1>
    </div>
    </div>
    
    <div class="row">
    <div class="col-lg-8 col-lg-offset-2">
    {% if is_form %}
      {% if is_create %}
      <form role="form" action="{% url 'reports:create' %}" method="post" >
      {% else %}
      <form role="form" action="{% url 'reports:change' report_id %}" method="post" >
      {% endif %}
      {% csrf_token %}
      
      {{ form.non_field_errors }}
      <div class="form-group">
         <div class="row"><div class="col-lg-2">
         {{ form.title.errors }}
         </div></div>
         <div class="row">
         <div class="col-lg-2">
           <label for="{{ form.title.id_for_label }}">标题:</label>
         </div>
         <div class="col-lg-6">
            {{ form.title }}
         </div>
         </div>
       </div>
      
       <div class="form-group">
         <div class="row"><div class="col-lg-2">
         {{ form.persion.errors }}
         </div></div>
            <label class="persion-format" for="{{ form.persion.id_for_label}}">参与人员:</label>
         <!--div class="col-lg-3"-->
            {{form.persion}}
         <!--/div-->
         <div class="col-lg-1" id="btn-persion">
             <!--span class="glyphicon glyphicon-plus-sign" aria-hidden="true" onclick="add_persion()"></span-->
             <button  type="button" class="btn btn-default" onclick="show_one_class_ele('persion-format','btn-persion')">
               <span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span>
             </button>
         </div>
       </div>
       
       <div class="form-group">
         <div class="row">
         <div class="col-lg-2">
           <label for="{{ form.start_time.id_for_label }}">开始时间:</label>
         </div>
         <div class="col-lg-3">
            {{form.start_time}}
         </div>
         <div class="col-lg-7">
         {{ form.start_time.errors }}
         </div>
         </div>
       </div>
       
       <div class="form-group">
         <div class="row">
         <div class="col-lg-2">
           <label for="{{ form.end_time.id_for_label }}">结束时间:</label>
         </div>
         <div class="col-lg-3">
            {{form.end_time}}
         </div>
         <div class="col-lg-7">
         {{ form.end_time.errors }}
         </div>
         </div>
       </div>
       
       <div class="form-group">
         <div class="row"><div class="col-lg-12">
         {{ form.domain.errors }}
         </div></div>
            <label class="domain-format" for="{{ form.domain.id_for_label }}">攻击域名:</label>
         <!--div class="col-lg-3"-->
            {{form.domain}}
         <!--/div-->
         <div class="col-lg-1" id="btn-domain">
             <button type="button" class="btn btn-default" onclick="show_one_class_ele('domain-format','btn-domain')">
               <span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span>
             </button>
         </div>
       </div>
       
       <div class="form-group">
         <div class="row"><div class="col-lg-12">
         {{ form.ip.errors }}
         </div></div>
           <label class="ip-format" for="{{ form.ip.id_for_label }}">来源IP:</label>
         <!--div class="col-lg-3"-->
            {{form.ip}}
         <!--/div-->
         <div class="col-lg-1" id="btn-ip">
             <button type="button" class="btn btn-default" onclick="show_one_class_ele('ip-format','btn-ip')">
               <span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span>
             </button>
         </div>
       </div>
       
       <div class="form-group">
         <div class="row"><div class="col-lg-12">
         {{ form.abstract.errors }}
         </div></div>
         <div class="row">
         <div class="col-lg-2">
           <label for="{{ form.abstract.id_for_label }}">摘要:</label>
         </div>
         <div class="col-lg-8">
            {{form.abstract}}
         </div>
         </div>
       </div>
       
       <div class="form-group">
         <div class="row"><div class="col-lg-12">
         {{ form.process.errors }}
         </div></div>
           <label class="process-format" for="{{ form.process.id_for_label }}">处理过程:</label>
           {{ form.process }}
           <div class="col-lg-1" id="btn-process">
             <button type="button" class="btn btn-default" onclick="show_one_class_ele('process-format','btn-process')">
               <span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span>添加
             </button>
          </div>
       </div>
       
       
       
       
      <hr>
      <div class="form-group">
         <div class="row"><div class="col-lg-12">
         {{ form.mrtg_image.errors }}
         </div></div>
         <div class="row"><div class="col-lg-2">
           <label for="{{ form.mrtg_image.id_for_label }}">选择MRTG图像:</label>
         </div></div>
         <div class="row">
            {% for mii in form.mrtg_image %}
              {{mii}}
            {% if forloop.counter|divisibleby:"4" %}
         </div>
         <div class="row">
            {% endif %}
         {% endfor %}
         </div>
         {% for key,value in mrtg_image_dic.items %}
            <img src="{{mrtg_image_prefix}}{{value}}" class="img-thumbnail mrtg-format" index="{{key}}"></img>
         {% endfor %}
       </div>
       
       

      
      {# dnsla图片不支持选择 #}
      <div class="form-group">
         <div class="row"><div class="col-lg-12">
         {{ form.mrtg_image.errors }}
         </div></div>
         <div class="row"><div class="col-lg-2">
           <label for="{{ form.mrtg_image.id_for_label }}">DNSLA图像:</label>
         </div></div>
         {% for nb,val in dnsla_image_dic.items %}
         
         <div class="row dnsla-img" id="dnsla-img-head{{nb}}"><div class="col-lg-12"><br>
         <hr><p>{{val.name}}</p></div></div>
         <div class="row dnsla-img" id="dnsla-img{{nb}}">
            <div class="col-lg-6" id="dnsla-dname-img{{nb}}" style="height:400px">
            </div>
            <div class="col-lg-6" id="dnsla-addr-img{{nb}}" style="height:400px">
            </div>
         </div>
         
         {% endfor %}
       </div>
       
        <div class="row">
          <div class="col-lg-1 col-lg-offset-4" >
            <a class="btn btn-danger" href="{% url 'reports:index' %}">取消</a>
          </div>
          <div class="col-lg-1 col-lg-offset-1" >
            <button type="submit" value="提交" class="btn btn-success">提交</button>
          </div>
        </div>
    </form>
    
    {% else %}
      {% if success %}
        <p>{{success}}</p>
      {% else %}
        <p>{{error_message}}</p>
      {% endif %}
    {% endif %}
    
    </div>
    </div>
  </body>
</html>
