{% load staticfiles %}

<!DOCTYPE html>
<html>
   <head>
      <title>报告预览</title>
      <!-- 引入 Bootstrap -->
      <link href="{% static 'reports/css/bootstrap.min.css' %}" rel="stylesheet">
      <script type="text/javascript" src="{% static 'reports/js/jquery.js' %}"></script>
      <!-- 包括所有已编译的插件 -->
      <script type="text/javascript" src="{% static 'reports/js/bootstrap.min.js' %}"></script>
      <script type="text/javascript" src="{% static 'reports/dist/echarts.js' %}"></script>
      <script type="text/javascript">
      $(function () {
        {% if report %}
            get_dnsla_data_by_reportid("{{report.id}}")
        {% endif %}
        $(".dnsla-img").hide();
        
      })
      function change(id){
            $('#myModal').modal('show');
            $('div.modal-footer').children('button.btn-primary').click(function(){
                window.location.href='/reports/'+id+'/change/'; 
            })
        }
      function get_dnsla_data_by_reportid(value){
        if(value!=""){
            $.ajax({
                type: 'get',
                url: '/reports/getDnslaOldData/'+value+'/' ,
                success: function(data){
                    // ECharts路径配置
                    require.config({
                        paths: {
                            echarts: "{% static 'reports/dist' %}"
                        }
                    });
                    // 使用
                    require(['echarts','echarts/chart/bar' // 使用柱状图就加载bar模块，按需加载
                    ],
                        function (ec) {
                            for( key in data){
                                //显示画布
                                $("#dnsla-img"+key).show();
                                $("#dnsla-img-head"+key).show();
                                // 基于准备好的dom，初始化echarts图表
                                var myChart_dname = ec.init(document.getElementById('dnsla-dname-img'+key));
                                var myChart_addr = ec.init(document.getElementById('dnsla-addr-img'+key));
                                //var myChart = ec.init(document.getElementById('dnsla-dname-img1'));                      
                                 var option_dname = {
                                    title:{text:'域名',x:'center'},
                                    tooltip: {trigger:'axis'},
                                    xAxis : [{type : 'value'}],
                                    yAxis : [{"type" : 'category',"data" : data[key].dname.y}],
                                    series : [{"name":"","type":"bar","data":data[key].dname.x}]
                                };
                                var option_addr = {
                                    title:{text:'ip',x:'center'},
                                    tooltip: {trigger:'axis'},
                                    xAxis : [{type : 'value'}],
                                    yAxis : [{"type" : 'category',"data" : data[key].addr.y}],
                                    series : [{"name":"","type":"bar","data":data[key].addr.x}]
                                };
                                
                                // 为echarts对象加载数据  渲染dnsla数据
                                myChart_dname.setOption(option_dname); 
                                myChart_addr.setOption(option_addr); 
                                }
                        }
                    );
                } ,
                dataType: 'json'
            });//ajax
        }//if
      }
      function rankbyid(){
        $('#nodebody tr').sort(sortid).appendTo("#nodebody");
      }
      function rankbyqps(){
        $('#nodebody tr').sort(sortqps).appendTo("#nodebody");
      }
      function sortqps(a,b){
        //return a.innerHTML.toLowerCase() > b.innerHTML.toLowerCase() ? 1 : -1;
        return Number($(a).children(".max").text()) > Number($(b).children(".max").text()) ? -1 : 1;
        
      };
      function sortid(a,b){
        //return a.innerHTML.toLowerCase() > b.innerHTML.toLowerCase() ? 1 : -1;
        return Number($(a).attr("id")) > Number($(b).attr("id")) ? 1 : -1;
        
      };
     
    
      </script>
   </head>

  <body>
  {% if report %}
  <div class="container-fluid">
    <div class="row">
    <div class="col-lg-6 col-lg-offset-3">
        
        <h2 id="report-title"><b><center>{{report.title}}</center></b></h2>
        <br/>
		<p align="right" id="report-date"><b>填表日期：{{create_time}}</b></p>
		<br/>
		
		<p id="report-person">
		  <b>值班人员：
		    {% for persion in persions %}
		        {{persion}} 
		    {% endfor %}
		  </b>
		</p>
		<p id="report-time"><b>故障时间：{{year}}年{{month}}月{{day}}日{{start_time}}–{{end_day}}日{{end_time}}</b></p>
		<p id="report-type"><b>故障类型：域名、网络、安全</b></p>
		<p id="report-area"><b>影响范围：
		    {% for node in attact_nodes %}
		        {{node.name}}
		    {% endfor %}
		</b></p><br/><br/>
		<h3 id="report-abstract-head" ><b>故障摘要</b></h3>
		<code style="font-size:14px">&nbsp&nbsp&nbsp&nbsp{{report.abstract}}
		</code>
		
		<h3 id="report-phe-head"><b>故障现象（主要部分）</b></h3>
		<div id="report-phe" class="panel panel-default">
		  <table class="table table-hover">
		   <!--caption></caption-->
		   <thead>
			  <tr>
				 <th>节点名称<span class="glyphicon glyphicon-triangle-bottom" onclick="rankbyid()"></span></th>
				 <th>平均QPS</th>
				 <th>峰值QPS<span class="glyphicon glyphicon-triangle-bottom" onclick="rankbyqps()"></span></th>
			  </tr>
		   </thead>
		   <tbody id="nodebody">
		   {% for node in attact_nodes %}
			  <tr id="{{node.nb}}">
				 <td id="name{{node.nb}}">{{node.name}}</td>
				 <td id="average{{node.nb}}">{{node.average_qps}}</td>
				 <td class="max">{{node.max_qps}}</td>
			  </tr>
           {% endfor %}
		   </tbody>
		  </table>
		</div>
		
		<h3 id="report-process-head"><b>处理过程</b></h3>
		<div id="report-process" class="panel panel-default">
		  <!--div class="panel-heading">面板标题</div-->
		  <table class="table table-hover">
		    <tbody>
		    {% for process in processes %}
		      {% ifnotequal process '' %}
				<tr>
				 <td>{{process}}</td>
				</tr>
              {% endifnotequal %}
            {% endfor %}
            </tbody>
          </table>
        </div>
		
		<h3 id="report-mrtg-image"><b>附录一  MRTG图像</b></h3>
		
		
		<div class="row">
		{% for an in attact_nodes %}
		<!--img src="{% static 'reports/images/Jelly_Fish_by_RaDu_GaLaN.jpg' %}" class="img-thumbnail"></img-->
		  <div  class="col-lg-4">
		    <p>{{an.name}}<p>
		    <img src="{{an.picture.url}}" class="img-thumbnail"></img>
		  </div>
		  
		{% if forloop.counter|divisibleby:"3" %}
        </div>
        <hr>
        <div class="row">
        {% endif %}
        {% endfor %}
		</div>
		
		
		<h3 id="report-mrtg-image"><b>附录二  DNSLA图像</b></h3>
		
		{% for an in attact_nodes %}
		<div class="row dnsla-img" id="dnsla-img-head{{an.nb}}"><div  class="col-lg-12"></div><p>{{an.name}}<p></div>
		<div class="row dnsla-img" id="dnsla-img{{an.nb}}">
		<!--img src="{% static 'reports/images/Jelly_Fish_by_RaDu_GaLaN.jpg' %}" class="img-thumbnail"></img-->
		  <div  class="col-lg-6" id="dnsla-dname-img{{an.nb}}" style="height:400px"></div>
		  <div  class="col-lg-6" id="dnsla-addr-img{{an.nb}}" style="height:400px"></div>
		</div>
		<hr>
		{% endfor %}
		
		<div class="row">
          <div class="col-lg-1 col-lg-offset-4" >
            <a class="btn btn-success" onclick="change({{report.id}})">修改</a>
          </div>
          <div class="col-lg-1 col-lg-offset-1" >
            <a class="btn btn-primary" href="{% url 'reports:index' %}">确定</a>
          </div>
        </div>
	</div>
    </div>
  </div>
  {% endif %}
    <!-- 模态框（Modal） -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" 
       aria-labelledby="myModalLabel" aria-hidden="true">
       <div class="modal-dialog">
          <div class="modal-content">
             <div class="modal-header">
                <button type="button" class="close" 
                   data-dismiss="modal" aria-hidden="true">
                      &times;
                </button>
                <h3 class="modal-title" id="myModalLabel">
                   提示
                </h3>
             </div>
             <div class="modal-body">
                <h4>修改报告会覆盖之前保存的mrtg图片,确认修改么?</h4>
             </div>
             <div class="modal-footer">
                <button type="button" class="btn btn-default" 
                   data-dismiss="modal">关闭
                </button>
                <button type="button" class="btn btn-primary">
                   确认
                </button>
             </div>
          </div><!-- /.modal-content -->
    </div><!-- /.modal -->

  </body>
</html>
